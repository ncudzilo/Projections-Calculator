import React, { useState, useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area } from 'recharts';
import { Info, Users, Clock, DollarSign, Zap } from 'lucide-react';

const PatientCalculator = () => {
  // --- State Inputs ---
  const [monthlyGrowth, setMonthlyGrowth] = useState(30);
  const [monthlyFee, setMonthlyFee] = useState(90);
  const [hoursPerQuarter, setHoursPerQuarter] = useState(1);
  const [oneTimeFee, setOneTimeFee] = useState(500);
  const [workHoursLimit, setWorkHoursLimit] = useState(40);

  // --- Calculations ---
  const data = useMemo(() => {
    let results = [];
    let currentPatients = 0;
    let cumulativeEarnings = 0;

    for (let month = 1; month <= 36; month++) {
      currentPatients += monthlyGrowth;
      
      // Hourly workload check: (Patients * hours per quarter) / 3 months in a quarter
      const hoursRequiredMonthly = (currentPatients * hoursPerQuarter) / 3;
      const hoursRequiredWeekly = (hoursRequiredMonthly / 4.33);
      
      const recurringRevenue = currentPatients * monthlyFee;
      const oneTimeRevenue = monthlyGrowth * oneTimeFee;
      const totalMonthlyRevenue = recurringRevenue + oneTimeRevenue;
      
      cumulativeEarnings += totalMonthlyRevenue;

      results.push({
        month,
        year: Math.ceil(month / 12),
        patients: currentPatients,
        revenue: totalMonthlyRevenue,
        recurring: recurringRevenue,
        weeklyHours: hoursRequiredWeekly.toFixed(1),
        isOverCapacity: hoursRequiredWeekly > workHoursLimit
      });
    }
    return results;
  }, [monthlyGrowth, monthlyFee, hoursPerQuarter, oneTimeFee, workHoursLimit]);

  const capacity = Math.floor((workHoursLimit * 4.33 * 3) / hoursPerQuarter);
  const maxMonthlyRevenue = capacity * monthlyFee;

  return (
    <div className="min-h-screen bg-[#0f1115] text-gray-100 p-8 font-sans">
      <div className="max-w-6xl mx-auto">
        
        {/* Header */}
        <header className="mb-12 border-l-4 border-[#f8cc74] pl-6">
          <h1 className="text-4xl font-bold tracking-tight">Practice Scalability <span className="text-[#f8cc74]">Engine</span></h1>
          <p className="text-gray-400 mt-2">Model your growth, capacity, and revenue across a 3-year horizon.</p>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* Controls Panel */}
          <div className="bg-[#1a1d23] p-6 rounded-2xl border border-gray-800 space-y-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Zap size={20} className="text-[#f8cc74]" /> Core Inputs
            </h2>

            <div>
              <label className="block text-sm text-gray-400 mb-2 flex items-center gap-2">
                New Patients / Month
                <Info size={14} className="cursor-help" title="How many new clients you onboard every 30 days" />
              </label>
              <input type="number" value={monthlyGrowth} onChange={(e) => setMonthlyGrowth(Number(e.target.value))} 
                className="w-full bg-[#0f1115] border border-gray-700 rounded-lg p-3 text-[#f8cc74] focus:border-[#f8cc74] outline-none" />
            </div>

            <div>
              <label className="block text-sm text-gray-400 mb-2">Monthly Recurring Fee ($)</label>
              <input type="number" value={monthlyFee} onChange={(e) => setMonthlyFee(Number(e.target.value))} 
                className="w-full bg-[#0f1115] border border-gray-700 rounded-lg p-3 text-[#f8cc74] focus:border-[#f8cc74] outline-none" />
            </div>

            <div>
              <label className="block text-sm text-gray-400 mb-2">One-Time Program Fee ($)</label>
              <input type="number" value={oneTimeFee} onChange={(e) => setOneTimeFee(Number(e.target.value))} 
                className="w-full bg-[#0f1115] border border-gray-700 rounded-lg p-3 text-[#f8cc74] focus:border-[#f8cc74] outline-none" />
            </div>

            <div className="pt-4 border-t border-gray-800">
              <label className="block text-sm text-gray-400 mb-2">Hours per Patient / Quarter</label>
              <input type="number" step="0.5" value={hoursPerQuarter} onChange={(e) => setHoursPerQuarter(Number(e.target.value))} 
                className="w-full bg-[#0f1115] border border-gray-700 rounded-lg p-3 text-[#f8cc74] focus:border-[#f8cc74] outline-none" />
            </div>
          </div>

          {/* Main Chart Area */}
          <div className="lg:col-span-2 space-y-8">
            
            {/* Top Metrics Row */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <MetricCard label="Patient Capacity" value={capacity} icon={<Users size={20}/>} sub="At 40 hrs/wk limit" />
              <MetricCard label="Hourly Rate" value={`$${(monthlyFee * 3 / hoursPerQuarter).toFixed(0)}`} icon={<Clock size={20}/>} sub="Based on quarterly time" />
              <MetricCard label="Max Monthly Rev" value={`$${maxMonthlyRevenue.toLocaleString()}`} icon={<DollarSign size={20}/>} sub="Subscription only" />
            </div>

            {/* Growth Chart */}
            <div className="bg-[#1a1d23] p-6 rounded-2xl border border-gray-800 h-96">
              <h3 className="text-lg font-medium mb-6">3-Year Revenue Growth</h3>
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={data}>
                  <defs>
                    <linearGradient id="colorRev" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#f8cc74" stopOpacity={0.3}/>
                      <stop offset="95%" stopColor="#f8cc74" stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#2d3139" />
                  <XAxis dataKey="month" stroke="#6b7280" label={{ value: 'Months', position: 'insideBottom', offset: -5 }} />
                  <YAxis stroke="#6b7280" />
                  <Tooltip contentStyle={{ backgroundColor: '#1a1d23', border: '1px solid #374151' }} />
                  <Area type="monotone" dataKey="revenue" stroke="#f8cc74" fillOpacity={1} fill="url(#colorRev)" />
                </AreaChart>
              </ResponsiveContainer>
            </div>

            {/* Capacity Logic Section */}
            <div className="bg-[#1a1d23] p-6 rounded-2xl border border-gray-800">
              <h3 className="text-lg font-medium mb-4 italic text-gray-400 font-serif">Capacity Insight</h3>
              <p className="text-sm leading-relaxed">
                At your current rate of <span className="text-[#f8cc74] font-bold">{monthlyGrowth} new patients/month</span>, you will reach your 40-hour weekly capacity in 
                <span className="text-[#f8cc74] font-bold"> {Math.round(capacity / monthlyGrowth)} months</span>. 
                Beyond this point, you must either increase your rates, decrease time per patient, or hire staff to scale further.
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
};

const MetricCard = ({ label, value, icon, sub }) => (
  <div className="bg-[#1a1d23] p-5 rounded-2xl border border-gray-800">
    <div className="flex items-center justify-between mb-2 text-gray-400">
      <span className="text-xs uppercase tracking-wider font-semibold">{label}</span>
      <span className="text-[#f8cc74]">{icon}</span>
    </div>
    <div className="text-2xl font-bold text-white">{value}</div>
    <div className="text-[10px] text-gray-500 mt-1 uppercase tracking-tighter">{sub}</div>
  </div>
);

export default PatientCalculator;
